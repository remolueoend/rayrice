#!/usr/bin/env sh

login () {
    local token=$(dmenupass "enter 1Password keyphrase:" | xargs | op signin my --raw)
    echo "$token" | secret-tool store --label "1password cli session token" "x-app" "1password-cli" "x-type" "session-token"
    echo "$token"
}

retrieve_token () {
    secret-tool lookup "x-app" "1password-cli" "x-type" "session-token"
}

get_items () {
    OP_SESSION_my="$1" op list items
}

get_item_details () {
    OP_SESSION_my="$1" op get item "$2"
}

get_item_pw () {
    case $(echo "$1" | jq -r '.templateUuid') in
        "001")
            # logins
            echo "$1" | jq -r '.details.fields[] | select(.type=="P").value'
            ;;
        "006")
            # documents
            echo "$1" | jq -r '.details.sections[].fields[] | select(.t=="Password").v' 
            ;;
        "110")
            # servers
            echo "$1" | jq -r '.details.sections[].fields[] | select(.t=="password").v' 
            ;;
        *)
            echo "unknown template type."
            exit 11
            ;;
    esac
}

token=$(retrieve_token)
if ! items=$(get_items "$token"); then
    token=$(login)
    items=$(get_items "$token")
fi

item_names=$(echo "$items" | jq -r '.[].overview.title')
selected_index=$(echo "$item_names" | rofi -dmenu -i -format d)
selected_id=$(echo "$items" | jq -r --arg idx $selected_index '.[$idx | tonumber - 1].uuid')

item_details=$(get_item_details "$token" "$selected_id")

if [[ $1 == "--item" ]]; then
    echo "$item_details" | jq
    exit 0
fi

password=$(get_item_pw "$item_details")

if [[ $1 == "--print" ]]; then
    echo $password
    exit 0
fi

echo "$password" | tr -d '\n' | xclip -selection clipboard
item_title=$(echo "$item_details" | jq '.overview.title')
notify-send "rofi-1password" "password for $item_title copied to clipboard"
